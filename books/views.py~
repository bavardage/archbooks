from models import Genre, Author, Series, Book, Review
from forms import GenreForm, AuthorForm, SeriesForm, BookForm, ReviewForm

from django.contrib.auth.decorators import login_required
from django.shortcuts import render_to_response, get_object_or_404
from django.template import RequestContext
from django.http import HttpResponse, Http404, HttpResponseRedirect

@login_required
def add(request, add_what = None):
    modeldict = {'book': (Book, BookForm), 'author': (Author, AuthorForm), 'genre': (Genre, GenreForm), 'series': (Series, SeriesForm), 'review': (Review, ReviewForm)}
    if add_what not in modeldict:
        raise Http404

    model, modelform = modeldict[add_what]
    popup = (request.GET['popup'] if 'popup' in request.GET else None)
    print "popup is", popup
    specialfields = {'authors': 'author', 'series': 'series', 'genre': 'genre', 'for_book': 'book'}
    
    if request.method == 'POST':
        form = modelform(request.POST, request.FILES)
        if form.is_valid():
            saved = form.save(commit=False)
            saved.created_by = request.user
            saved.save()
            try:
                saved.save_m2m()
            except AttributeError:
                pass
            if popup:
                return render_to_response('books/popup_close.html', RequestContext(request, {'added_what': saved, 'popup': popup}))
            else:
                return render_to_response('books/done.html', RequestContext(request, {'added_what': saved}))
    else: #form not already created - make one!
        form = modelform()
    return render_to_response('books/add.html', RequestContext(request, {'adding_what': add_what.title(), 'form': form, 'specials': specialfields}))
